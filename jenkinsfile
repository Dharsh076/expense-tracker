pipeline {
  agent any

  environment {
    // TODO 1: set your Docker Hub repo
    IMAGE_NAME            = "your-dockerhub-username/expense-tracker"
    IMAGE_TAG             = "${env.BUILD_NUMBER}"

    // TODO 2: set Jenkins credential IDs
    DOCKERHUB_CREDENTIALS = "dockerhub-creds"          // username/password
    RENDER_DEPLOY_HOOK    = credentials('render-deploy-hook') // Secret Text = Render Deploy Hook URL

    // TODO 3: set your live Render URL (no trailing slash)
    RENDER_SERVICE_URL    = "https://expense-tracker-1-hj0i.onrender.com"

    // Optional: if you prefer to pin a repo URL here, keep GIT_REPO_URL
    GIT_REPO_URL          = "https://github.com/Dharsh076/expense-tracker.git"
  }

  options {
    timestamps()
    ansiColor('xterm')
    buildDiscarder(logRotator(numToKeepStr: '25'))
  }

  stages {
    stage('Checkout') {
      steps {
        // If the job is "Pipeline script from SCM", you can use: checkout scm
        checkout([$class: 'GitSCM',
          branches: [[name: '*/main']],
          userRemoteConfigs: [[url: "${GIT_REPO_URL}"]]
        ])
      }
    }

    stage('Unit Tests') {
      steps {
        sh 'python3 --version || true'
        sh 'pip3 --version || true'
        sh 'pip3 install -r requirements.txt'
        sh 'pytest'
      }
    }

    stage('Build Docker Image') {
      steps {
        sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} -t ${IMAGE_NAME}:latest ."
      }
    }

    stage('Push Image') {
      steps {
        withCredentials([usernamePassword(credentialsId: "${DOCKERHUB_CREDENTIALS}", usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
          sh 'echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin'
          sh "docker push ${IMAGE_NAME}:${IMAGE_TAG}"
          sh "docker push ${IMAGE_NAME}:latest"
        }
      }
    }

    // üîΩ NEW: Trigger Render deployment via deploy hook
    stage('Trigger Render Deploy') {
      when { branch 'main' }
      steps {
        sh 'curl -fsS -X POST "$RENDER_DEPLOY_HOOK" > /dev/null'
        echo 'Render deploy triggered.'
      }
    }

    // üîΩ NEW: Wait for the app to become healthy
    stage('Wait for Health') {
      when { branch 'main' }
      steps {
        sh '''
          set -e
          for i in $(seq 1 30); do
            echo "Health check attempt $i..."
            if curl -fsS "$RENDER_SERVICE_URL/health" > /dev/null; then
              echo "Service is healthy ‚úÖ"
              exit 0
            fi
            sleep 10
          done
          echo "Service did not become healthy in time ‚ùå"
          exit 1
        '''
      }
    }
  }

  post {
    success { echo '‚úÖ CI/CD complete: built, pushed, and deployed to Render.' }
    failure { echo '‚ùå Pipeline failed. Check logs above.' }
  }
}
